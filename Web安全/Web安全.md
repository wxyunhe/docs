## SQL 注入

https://www.kanxue.com/book-6-110.htm

？什么是sql注入

### 注入测试

分为数字型、字符型、搜索型



### 原理

sql 注入的问题是后台使用字符串拼接的方法构造 sql，构造 sql 的一部分内容由用户提供，这部分内容包含的参数没有经过过滤，使带有特殊符号的语句被 sql 解析器执行


### 防御方法

## 文件上传

https://www.kanxue.com/book-6-235.htm

1. 网站web应用都有一些文件上传功能，比如文档、图片、头像、视频上传，
2. 当上传功能的实现代码没有严格校验上传文件的后缀和文件类型，此时攻击者就可以上传一个webshell到一个web可访问的目录上，并将恶意文件传递给PHP解释器去执行，之后就可以在服务器上执行恶意代码，进行数据库执行、服务器文件管理，服务器命令执行等恶意操作。
3. 根据网站使用及可解析的程序脚本不同，此处可以上传的恶意脚本可以是PHP、ASP、JSP文件，也可以是篡改后缀后的这几类脚本。
 
> WebShell 就是以 asp、php、jsp 或者 cgi 等网页文件形式存在的一种命令执行环境，也可以将其称之为 一种网页后门。攻击者在入侵了一个网站后，通常会将这些 asp 或 php 后门文件与网站服务器 web 目录 下正常的网页文件混在一起，然后使用浏览器来访问这些后门，得到一个命令执行环境，以达到控制网站服务器的目的(可以上传下载或者修改文件，操作数据库，执行任意命令等）。

### 漏洞绕过

### 上传文件的分类与总结

1. 上传文件是PHP、JSP、ASP等脚本代码，服务器的Web容器解释并执行了用户上传的脚本，导致代码执行
2. 上传文件是crossdomain.xml，导致可以控制Flash在该域下的行为(其他通过类似方式控制策略文件的情况类似);
3. 上传文件是病毒、木马文件，黑客用以诱骗用户或者管理员下载执行植入到pc中。
4. 上传文件是钓鱼图片或为包含了脚本的图片，在某些版本的浏览器中会被作为脚本执行，被用于钓鱼和欺诈。
 
在大多数情况下，文件上传漏洞一般都是指“上传的Web脚本被服务器解析从而获取网站shell权限”，也就是webshell，要完成上传漏洞攻击需要满足以下几个条件:
 
1. 上传的文件能够被Web容器解释执行，所以文件上传后所在的目录需要解析器可以执行目录下的文件，也就是说文件目录必须在web容器覆盖路径内才行。
2. 用户可以直接通过浏览器进行访问这个shell文件，如果web容器不能解析这个文件，那么也不能算是漏洞。
3. 最后，上传的shell文件如果被安全检查、格式化、图片压缩等功能改变了内容，则也可能导致攻击不成功。

### 防御方法

1. 设置文件上传的目录设置为不可执行
1. 使用白名单方式检查文件类型。处理图片可以使用压缩函数或者resize函数，在处理图片的同时破坏图片中可能包含的恶意代码。
1. 对文件进行随机性且不可猜解的重命名。
1. 不能有本地文件包含漏洞及解析漏洞。（解析漏洞后面会讲到）

## XSS

XSS - Cross Site Scripting 指跨站脚本攻击，属于注入攻击的一种

### 形成原因

- web应用对用户输入过滤不严格
- 攻击者写入恶意的脚本代码（HTML、JavaScript）到网页中
- 用户访问含有恶意代码的页面，恶意脚本被浏览器解析执行

常见的危害有：cookie窃取，session劫持，钓鱼攻击，蠕虫，ddos等。

### 分类

> 反射型、存储型、DOM 型

1. 反射型
	1. 出现在URL参数中及网站搜索栏中
	2. 由于需要点击包含恶意代码的URL才可以触发，并且只能触发一次，所以也被称为“非持久性xss”。

2. 存储型
	1. 出现在网站 留言板，评论，个人资料 等用户可以对网站写入数据的地方。比如一个论坛评论处由于对用户输入过滤不严格，导致攻击者在写入一段窃取cookie的恶意JavaScript代码到评论处，这段恶意代码会写入数据库，当其他用户浏览这个写入代码的页面时，网站从数据库中读取恶意代码显示到网页中被浏览器执行，导致用户cookie被窃取，攻击者无需受害者密码即可登录账户。所以也被称作“持久性xss”。持久性xss比反射型xss危害要大的多。

3. DOM 型
	1. 基于dom文档对象模型，前端脚本通过dom动态修改页面，由于不与服务端进行交互，而且代码是可见的，从前端获取dom中的数据在本地执行。  
	2. 常见的可以操纵dom的对象：URL，localtion,referrer等

### 案例分析
#### 反射型
https://www.kanxue.com/book-6-41.htm
#### 存储型
https://www.kanxue.com/book-6-42.htm
#### DOM型
https://www.kanxue.com/book-6-46.htm

## CSRF

CSRF (Cross Site Request Forgery)，中文全称跨站点请求伪造。

csrf会根据业务功能场景的不用而利用起来也不同，

这些请求都是跨域发起的，而且是在受害者的session没有失效通过身份认证的情况下发生的。
使用用户的登陆凭证，让用户自己在不知情的情况下，进行修改数据的操作。

但是查询数据的地方却不需要保护，因为csrf是借助受害者的cookie来进行攻击者需要的恶意操作的，攻击者并不能拿到受害者cookie，对于服务器返回的结果也无法解析查看，攻击者唯一可以做的就是让服务器执行自己的操作命令，或者说改变网站数据，而查询操作即不会改变数据也不会把结果返回给攻击者，所以并不需要保护。

### 常见危害与利用分类

1. 对网站管理员进行攻击
1. 修改受害网站上的用户账户和数据
1. 账户劫持
1. 传播CSRF蠕虫进行大规模攻击
1. 利用csrf进行拖库
1. 利用其他漏洞进行组合拳攻击
1. 针对路由器的csrf攻击

https://www.kanxue.com/book-6-59.htm

### 解决方案

对于CSRF的防御通常有以下三种方法：
 
1、使用验证码
 
csrf攻击一般都是在受害者不知情的情况下进行发起的，使用验证码可以有效的防止攻击，但是每次请求都要输入验证码会影响用户体验，所以通常只在用户登陆注册，还有一些特定业务场景下使用，比如银行转账。如何使用验证码要根据业务和场景来决定。

2、验证http Referer
 
http头中的referer字段记录了请求来源地址，比如从 http://www.test.com 点击链接到 http://m.test.com 之后，那么referer就是 http://www.test.com 这个地址。攻击者在对受害者进行攻击的时候，是在攻击者自己的服务器上构建自己的恶意脚本，诱骗受害者点击，所以此时的referer值就是攻击者自己的URL地址。

通过以上可知，csrf攻击都是跨域发起的，所以在服务端针对referer字段验证是否属于安全可靠的域名，可在一定程度上有效防御此类攻击。

但是此类方法并非万无一失，在低版本存在漏洞的浏览器中，黑客可以篡改referer值。另一种情况是csrf结合xss进行攻击，此时就不需要跨域发起，也可以绕过referer验证。
 

3、使用token
 
在说token如何防御csrf攻击之前，我们先了解下token的工作原理。

当用户第一次进行登陆的时候，客户端会通过用户名和密码去请求服务器登陆，服务端在收到请求后会验证客户端传来的用户名和密码，如果验证通过，服务器就会签发一个token发给客户端，并且将token放到session中，客户端收到token后存储到本地，以后客户端只要每次请求服务器就要带上token，经过服务器验证通过后才会返回响应数据，否则报错。
 
csrf攻击成功的前提条件是攻击者可以完全伪造出受害者的所有请求，而且请求中的验证信息都在cookie中，黑客只要使用用户的cookie通过安全验证就可以完成攻击。了解了这些之后，想要防止csrf攻击，就要在http请求中放置黑客不可以伪造的信息，而且该信息不可以存在于cookie中，否则就无效。而token令牌最大的特点就是随机性，不可预测，并且不存在于cookie当中。

对于GET请求，请求参数直接在URL当中，这样token的形式就为 http://xxx.com?csrftoken=tokenvalue ，但是这种方式把请求参数都放在URL中，会导致在referer中泄露，不仅如此，设想另一种场景，一个在内网系统的员工，从内部敏感系统在点击对外部提供服务的网站链接，此时就会把内网敏感信息通过referer泄漏出去。而对于POST请求，token是以隐藏表单存在，`<input type=”hidden” name=”csrftoken” value=”tokenvalue”/>`。
最后注意一点，如果在同域下存在xss漏洞，那么这种使用token的防御将形同虚设。

## SSRF

SSRF（Server-Side Request Forgery）服务端请求伪造 是一种由攻击者构造形成由服务端发起请求的一个安全漏洞。一般情况下，SSRF攻击的目标是从外网无法访问的内部系统。正是因为它是由服务端发起的，所以它能够请求到与它相连而与外网隔离的内部系统。

正常情况下，我们无法从外网去访问一个公司的内部系统，但是如果服务端提供了从其他服务器应用获取数据的功能且没有对目标地址做过滤与限制。比如从指定URL地址获取网页文本内容，加载指定地址的图片，下载等等。攻击者就可以利用该漏洞绕过防火墙等访问限制，进而将受感染或存在漏洞的服务器作为代理进行端口扫描，甚至是访问内部系统数据。

ssrf的攻击利用主要有以下几种：

1. 内网、本地端口扫描，获取开放端口信息
1. 主机信息收集，web应用指纹识别，获取服务banner信息
1. 根据识别出的应用针对性的发送payload攻击，例如struts2
1. 攻击内网和本地的应用程序及服务。
1. 穿越防火墙
1. 利用file协议读取本地文件，比如 file:///etc/passwd

### 漏洞挖掘和防御
https://www.kanxue.com/book-6-107.htm

## XXE

XXE（XML External Entity Injection）即xml外部实体注入
 
当程序在解析XML输入时，允许引用外部实体，导致能够引用一个外部恶意文件，可导致执行系统命令、内网端口探测、文件读取，攻击内网服务、dos攻击等。

xxe的修复与防御：
 
1. 使用开发语言提供的禁用外部实体的方法 PHP JAVA Python
2. 过滤用户提交的XML数据
	1. 过滤关键词：<!DOCTYPE，<!ENTITY，SYSTEM，PUBLIC。

https://www.kanxue.com/book-6-109.htm

前置知识：https://www.kanxue.com/book-6-108.htm

## 命令注入


## 面试问题：你对Web安全了解多少？

1. 简单介绍web安全
2. OWASP
3. 常见问题
	- XSS、CSRF 等